tinymce.PluginManager.add("custom_media",function(e){function t(e){return e.indexOf(".mp3")!=-1?"audio/mpeg":e.indexOf(".wav")!=-1?"audio/wav":e.indexOf(".mp4")!=-1?"video/mp4":e.indexOf(".webm")!=-1?"video/webm":e.indexOf(".ogg")!=-1?"video/ogg":""}function i(){function t(e){var t,o,r,n;t=i.find("#width")[0],o=i.find("#height")[0],r=t.value(),n=o.value(),i.find("#constrain")[0].checked()&&a&&c&&r&&n&&(e.control==t?(n=Math.round(r/a*n),o.value(n)):(r=Math.round(n/c*r),t.value(r))),a=r,c=n}var i,a,c,n;n=r(e.selection.getNode()),a=n.width,c=n.height,i=e.windowManager.open({title:"Insert/edit video",data:n,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){},items:[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"优酷视频网址"},{type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:4,size:4,onchange:t},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:4,size:4,onchange:t},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}]}],onSubmit:function(){e.insertContent(o(this.toJSON()))}})}function o(i){var o="";return i.source1||(tinymce.extend(i,a(i.embed)),i.source1)?(i.source1=e.convertURL(i.source1,"source"),i.source1mime=t(i.source1),i.embed?o=c(i.embed,i,!0):(tinymce.each(n,function(e){var t,o,a;if(t=e.regex.exec(i.source1)){for(a=e.url,o=0;t[o];o++)a=a.replace("$"+o,function(){return t[o]});i.source1=a,i.type=e.type,i.width=i.width||e.w,i.height=i.height||e.h}}),i.width=i.width||"100%",i.height=i.height||"auto",tinymce.each(i,function(t,o){i[o]=e.dom.encode(t)}),i.type=="iframe"?o+='<iframe src="'+i.source1+'" width="'+i.width+'" height="'+i.height+'"></iframe>':i.source1mime.indexOf("audio")!=-1?e.settings.audio_template_callback?o=e.settings.audio_template_callback(i):o+='<audio controls="controls" src="'+i.source1+'">'+(i.source2?'\n<source src="'+i.source2+'"'+(i.source2mime?' type="'+i.source2mime+'"':"")+" />\n":"")+"</audio>":o=e.settings.video_template_callback?e.settings.video_template_callback(i):'<video width="'+i.width+'" height="'+i.height+'"'+(i.poster?' poster="'+i.poster+'"':"")+' controls="controls">\n'+'<source src="'+i.source1+'"'+(i.source1mime?' type="'+i.source1mime+'"':"")+" />\n"+(i.source2?'<source src="'+i.source2+'"'+(i.source2mime?' type="'+i.source2mime+'"':"")+" />\n":"")+"</video>"),o):""}function a(e){var t={};return new tinymce.html.SaxParser({validate:!1,special:"script,noscript",start:function(e,i){t.source1||"param"!=e||(t.source1=i.map.movie),("iframe"==e||"object"==e||"embed"==e||"video"==e||"audio"==e)&&(t=tinymce.extend(i.map,t)),"source"==e&&(t.source1?t.source2||(t.source2=i.map.src):t.source1=i.map.src)}}).parse(e),t.source1=t.source1||t.src||t.data,t.source2=t.source2||"",t.poster=t.poster||"",t}function r(t){return t.getAttribute("data-mce-object")?a(e.serializer.serialize(t,{selection:!0})):{}}function c(e,t,i){function o(e,t){var i,o,a,r;for(i in t)if(a=""+t[i],e.map[i])for(o=e.length;o--;)r=e[o],r.name==i&&(a?(e.map[i]=a,r.value=a):(delete e.map[i],e.splice(o,1)));else a&&(e.push({name:i,value:a}),e.map[i]=a)}var a=new tinymce.html.Writer,r=0;return new tinymce.html.SaxParser({validate:!1,special:"script,noscript",comment:function(e){a.comment(e)},cdata:function(e){a.cdata(e)},text:function(e,t){a.text(e,t)},start:function(e,c,n){switch(e){case"video":case"object":case"img":case"iframe":o(c,{width:t.width,height:t.height})}if(i)switch(e){case"video":o(c,{poster:t.poster,src:""}),t.source2&&o(c,{src:""});break;case"iframe":o(c,{src:t.source1});break;case"source":if(r++,2>=r&&(o(c,{src:t["source"+r],type:t["source"+r+"mime"]}),!t["source"+r]))return}a.start(e,c,n)},end:function(e){if("video"==e&&i)for(var c=1;2>=c;c++)if(t["source"+c]){var n=[];n.map={},c>r&&(o(n,{src:t["source"+c],type:t["source"+c+"mime"]}),a.start("source",n,!0))}a.end(e)}},new tinymce.html.Schema({})).parse(e),a.getContent()}var n=[{regex:/youtu\.be\/([a-z1-9.-_]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$1"},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$2"},{regex:/player\.youku\.com\/embed\/(\w+)/,type:"iframe",w:425,h:350,url:"http://player.youku.com/embed/$1"},{regex:/http:\/\/v\.youku\.com\/v_show\/id_(\w+)\.html/,type:"iframe",w:600,h:350,url:"http://player.youku.com/embed/$1"},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"http://player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc"},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'http://maps.google.com/maps/ms?msid=$2&output=embed"'}];e.on("ResolveName",function(e){var t;e.target.nodeType==1&&(t=e.target.getAttribute("data-mce-object"))&&(e.name=t)}),e.on("preInit",function(){var t=e.schema.getSpecialElements();tinymce.each("video audio iframe object".split(" "),function(e){t[e]=new RegExp("</"+e+"[^>]*>","gi")}),e.schema.addValidElements("object[id|style|width|height|classid|codebase|*],embed[id|style|width|height|type|src|*],video[*],audio[*]");var i=e.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(e){i[e]={}}),e.parser.addNodeFilter("iframe,video,audio,object,embed",function(t,i){for(var o,a,r,c,n,s,m,u=t.length;u--;){for(a=t[u],r=new tinymce.html.Node("img",1),r.shortEnded=!0,s=a.attributes,o=s.length;o--;)c=s[o].name,n=s[o].value,"width"!==c&&"height"!==c&&"style"!==c&&(("data"==c||"src"==c)&&(n=e.convertURL(n,c)),r.attr("data-mce-p-"+c,n));m=a.firstChild&&a.firstChild.value,m&&(r.attr("data-mce-html",escape(m)),r.firstChild=null),r.attr({width:a.attr("width")||"300",height:a.attr("height")||("audio"==i?"30":"150"),style:a.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":i,"class":"mce-object mce-object-"+i}),a.replace(r)}}),e.serializer.addAttributeFilter("data-mce-object",function(e,t){for(var i,o,a,r,c,n,s=e.length;s--;){for(i=e[s],o=new tinymce.html.Node(i.attr(t),1),i.attr(t)!="audio"&&o.attr({width:i.attr("width"),height:i.attr("height")}),o.attr({style:i.attr("style")}),r=i.attributes,a=r.length;a--;){var m=r[a].name;m.indexOf("data-mce-p-")===0&&o.attr(m.substr(11),r[a].value)}c=i.attr("data-mce-html"),c&&(n=new tinymce.html.Node("#text",3),n.raw=!0,n.value=unescape(c),o.append(n)),i.replace(o)}})}),e.on("ObjectSelected",function(e){e.target.getAttribute("data-mce-object")=="audio"&&e.preventDefault()}),e.on("objectResized",function(e){var t,i=e.target;i.getAttribute("data-mce-object")&&(t=i.getAttribute("data-mce-html"),t&&(t=unescape(t),i.setAttribute("data-mce-html",escape(c(t,{width:e.width,height:e.height})))))}),e.addButton("custom_media",{icon:"media",tooltip:"Insert/edit video",onclick:i,stateSelector:"img[data-mce-object=video]"}),e.addMenuItem("media",{icon:"media",text:"Insert video",onclick:i,context:"insert",prependToContext:!0})});